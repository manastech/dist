#!/bin/bash

. /usr/share/debconf/confmodule

case "$1" in
  configure)
    db_get <%= app_name %>/http_port && http_port="$RET"
    echo "HTTP_PORT=$http_port" > /etc/default/<%= app_name %>

<% i = 0 %>
<% config.sections.each do |section| %>
<% section.properties.each do |property| %>
    db_get <%= app_name %>/<%= property.full_name %> && property<%= i %>="$RET"
<% i += 1 %>
<% end %>
<% end %>

    tmpfile=`mktemp`
    cat << EOF > $tmpfile
require 'yaml'

<% i = 0 %>
<% config.sections.each do |section| %>
yaml = YAML.load_file '<%= app_root %>/config/<%= section.name %>.yml'
hash = yaml['production'] || yaml
<% section.properties.each do |property| %>
hash['<%= property.name %>'] = ARGV[<%= i %>]
<% i += 1 %>
<% end %>
File.open('<%= app_root %>/config/<%= section.name %>.yml', 'w') do |file|
  YAML.dump yaml, file
end
<% end %>
EOF
    ruby1.9.1 $tmpfile <%= (0 ... i).map { |n| "$property#{n}" }.join ' ' %>
    rm $tmpfile

    if [ ! -e /etc/<%= app_name %>/database.yml ]; then
      db_password=`ruby1.9.1 -e "print (0...16).map{ (('a'..'z').to_a + ('A'..'Z').to_a + ('0'..'9').to_a)[rand(62)] }.join"`

      tmpfile=`mktemp`
      cat << EOF > $tmpfile
CREATE DATABASE IF NOT EXISTS <%= app_name %>;
GRANT ALL ON <%= app_name %>.* TO '<%= app_name %>'@'localhost' IDENTIFIED BY '$db_password';
EOF
      mysql --defaults-file=/etc/mysql/debian.cnf  < $tmpfile
      rm $tmpfile

      cat << EOF > /etc/<%= app_name %>/database.yml
production:
  adapter: mysql2
  encoding: utf8
  reconnect: true
  database: <%= app_name %>
  pool: 5
  username: <%= app_name %>
  password: $db_password
EOF
    fi

    cd <%= app_root %>
    export RAILS_ENV=production
    export GEM_HOME=<%= app_root %>/.gems
    export GEM_PATH=

    gem1.9.1 install bundler --no-ri --no-rdoc --conservative
    gem1.9.1 install rake -v=0.9.2.2 --no-ri --no-rdoc --conservative
    gem1.9.1 install passenger --no-ri --no-rdoc --conservative

    BUNDLE=<%= app_root %>/.gems/bin/bundle

    $BUNDLE install --deployment --without=development test assets
    $BUNDLE clean

    # Get the current DB version to check if it actually exists
    $BUNDLE exec rake db:version

    # Create or upgrade the database
    if [ $? -eq 0 ]; then
            $BUNDLE exec rake db:migrate
    else
            $BUNDLE exec rake db:setup
    fi

    start <%= app_name %>

  ;;
esac

exit 0
